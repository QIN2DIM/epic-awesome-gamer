name: Epic Awesome Gamer

on:
   # æ‰‹åŠ¨è§¦å‘
   workflow_dispatch:

  # å®šæ—¶è§¦å‘ - æ¯å¤©15:55 (UTC)è¿è¡Œä¸€æ¬¡
#  schedule:
#    - cron: '55 15 * * *'

jobs:
  epic-gamer:
    runs-on: ubuntu-latest
    timeout-minutes: 20  # å¢åŠ è¶…æ—¶æ—¶é—´ä»¥åº”å¯¹é•œåƒæ‹‰å–

    steps:
      # æ£€æŸ¥æ˜¯å¦ä¸ºç§æœ‰ä»“åº“
      - name: Check repository visibility
        run: |
          if [[ "${{ github.event.repository.private }}" != "true" ]]; then
            echo "âš ï¸ This workflow must be run in a private repository for security reasons."
            echo "Please fork this repository and make it private before running this workflow."
            exit 0
          fi
          echo "âœ… Running in private repository"

      # è®¾ç½® Docker Buildxï¼ˆç”¨äºç¼“å­˜ä¼˜åŒ–ï¼‰
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      # æ£€å‡ºä»£ç  - åªæ£€å‡ºå½“å‰åˆ†æ”¯ï¼Œé¿å…å¤æ‚çš„åˆ†æ”¯æ“ä½œ
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1  # åªè·å–æœ€æ–°æäº¤ï¼ŒåŠ å¿«æ£€å‡ºé€Ÿåº¦
          token: ${{ secrets.GITHUB_TOKEN }}

      # åˆ‡æ¢åˆ° data-persistence åˆ†æ”¯
      - name: Switch to data-persistence branch
        run: |
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          
          # è·å–è¿œç¨‹åˆ†æ”¯ä¿¡æ¯
          git fetch origin --prune
          
          # æ£€æŸ¥è¿œç¨‹åˆ†æ”¯æ˜¯å¦å­˜åœ¨å¹¶åˆ‡æ¢
          if git ls-remote --exit-code --heads origin data-persistence >/dev/null 2>&1; then
            echo "Switching to existing data-persistence branch..."
            git checkout -B data-persistence origin/data-persistence
          else
            echo "Creating new data-persistence branch..."
            git checkout -b data-persistence
            
            # åˆ›å»ºåˆå§‹ç›®å½•ç»“æ„
            mkdir -p volumes/{user_data,logs,runtime}
            touch volumes/user_data/.gitkeep
            touch volumes/logs/.gitkeep  
            touch volumes/runtime/.gitkeep
            
            git add volumes/
            git commit -m "Initialize persistence directories" || echo "Nothing to commit"
            git push -u origin data-persistence
          fi

      # å‡†å¤‡æŒä¹…åŒ–ç›®å½•å’Œæƒé™
      - name: Prepare volumes with correct permissions
        run: |
          # åˆ›å»ºç›®å½•ç»“æ„
          mkdir -p ${{ github.workspace }}/volumes/{user_data,logs,runtime}
          
          # è®¾ç½®æ­£ç¡®çš„æƒé™ï¼ˆè§£å†³æƒé™è¢«æ‹’ç»é—®é¢˜ï¼‰
          sudo chown -R $(id -u):$(id -g) ${{ github.workspace }}/volumes
          chmod -R 755 ${{ github.workspace }}/volumes
          
          # ä¸ºäº†ç¡®ä¿å®¹å™¨å†…çš„æƒé™æ­£ç¡®ï¼Œè®¾ç½®æ›´å®½æ¾çš„æƒé™
          chmod -R 777 ${{ github.workspace }}/volumes
          
          echo "Volume directories prepared with permissions:"
          ls -la ${{ github.workspace }}/volumes/
          find ${{ github.workspace }}/volumes -type d -exec ls -ld {} \;

      # Docker é•œåƒç¼“å­˜ä¼˜åŒ–
      - name: Cache Docker layers
        uses: actions/cache@v4
        with:
          path: /tmp/.buildx-cache
          key: ${{ runner.os }}-docker-${{ hashFiles('**/Dockerfile') }}
          restore-keys: |
            ${{ runner.os }}-docker-

      # é¢„æ‹‰å–å’Œç¼“å­˜ Docker é•œåƒ
      - name: Pull and cache Docker image
        run: |
          echo "Pulling Epic Awesome Gamer image..."
          
          # å°è¯•ä»ç¼“å­˜åŠ è½½é•œåƒ
          if docker load -i /tmp/epic-gamer-image.tar 2>/dev/null; then
            echo "Loaded image from cache"
          else
            echo "Pulling fresh image..."
            docker pull ghcr.io/qin2dim/epic-awesome-gamer:latest
            
            # ä¿å­˜é•œåƒåˆ°ç¼“å­˜
            mkdir -p /tmp
            docker save ghcr.io/qin2dim/epic-awesome-gamer:latest -o /tmp/epic-gamer-image.tar
          fi
          
          # æ˜¾ç¤ºé•œåƒä¿¡æ¯
          docker images | grep epic-awesome-gamer

      # è¿è¡Œå®¹å™¨ï¼ˆå®Œå…¨å¯¹åº” docker-compose é…ç½®ï¼‰
      - name: Run Epic Awesome Gamer
        run: |
          echo "Starting Epic Awesome Gamer container..."
          echo "Container configuration:"
          echo "  Memory limit: 4g"
          echo "  Shared memory: 2gb"
          echo "  Volumes mounted: user_data, logs, runtime"
          
          # è¿è¡Œå®¹å™¨ï¼Œé…ç½®ä¸ docker-compose.yaml å®Œå…¨ä¸€è‡´
          docker run \
            --rm \
            --name epic-awesome-gamer \
            --memory="4g" \
            --memory-swap="4g" \
            --shm-size="2gb" \
            -e EPIC_EMAIL="${{ secrets.EPIC_EMAIL }}" \
            -e EPIC_PASSWORD="${{ secrets.EPIC_PASSWORD }}" \
            -e GEMINI_API_KEY="${{ secrets.GEMINI_API_KEY }}" \
            -v "${{ github.workspace }}/volumes/user_data:/app/app/user_data" \
            -v "${{ github.workspace }}/volumes/logs:/app/app/logs" \
            -v "${{ github.workspace }}/volumes/runtime:/app/app/runtime" \
            --entrypoint "/usr/bin/tini" \
            ghcr.io/qin2dim/epic-awesome-gamer:latest \
            -- xvfb-run --auto-servernum --server-num=1 --server-args='-screen 0, 1920x1080x24' uv run app/deploy.py
          
          echo "Container execution completed"

      # æ£€æŸ¥ç”Ÿæˆçš„æ–‡ä»¶
      - name: Check generated files
        if: always()
        run: |
          echo "Checking volumes content after container run:"
          find ${{ github.workspace }}/volumes -type f -name "*" -exec ls -la {} \; || echo "No files found"
          
          echo "Disk usage:"
          du -sh ${{ github.workspace }}/volumes/* 2>/dev/null || echo "No volume data"

      # ä¿®å¤æ–‡ä»¶æƒé™é—®é¢˜å¹¶æäº¤
      - name: Fix permissions and commit persistence data
        if: always()
        run: |
          # ç¡®ä¿æˆ‘ä»¬åœ¨æ­£ç¡®çš„åˆ†æ”¯ä¸Š
          git checkout data-persistence
          
          # ä¿®å¤å¯èƒ½çš„æƒé™é—®é¢˜
          sudo chown -R $(id -u):$(id -g) ${{ github.workspace }}/volumes || true
          
          # æ˜¾ç¤ºå½“å‰çŠ¶æ€
          echo "Current git status:"
          git status
          
          echo "Files in volumes:"
          find volumes -type f -name "*" 2>/dev/null || echo "No files in volumes"
          
          # æ·»åŠ æ‰€æœ‰æ›´æ”¹
          git add volumes/ || true
          
          # æ£€æŸ¥æ˜¯å¦æœ‰æ›´æ”¹éœ€è¦æäº¤
          if git diff --staged --quiet; then
            echo "âœ… No changes to commit - volumes may be empty or unchanged"
          else
            # ç”Ÿæˆè¯¦ç»†çš„æäº¤ä¿¡æ¯
            TIMESTAMP=$(date -u +"%Y-%m-%d %H:%M:%S UTC")
            CHANGED_FILES=$(git diff --staged --name-only | wc -l)
            
            echo "ğŸ“ Committing $CHANGED_FILES changed files..."
            
            git commit -m "ğŸ”„ Update persistence data - $TIMESTAMP" \
              -m "ğŸ“Š Workflow run: ${{ github.run_id }}" \
              -m "ğŸš€ Triggered by: ${{ github.event_name }}" \
              -m "ğŸ“ Files changed: $CHANGED_FILES" || {
              echo "âš ï¸ Commit failed, but continuing..."
            }
            
            # æ¨é€æ›´æ”¹ï¼Œæ·»åŠ é‡è¯•æœºåˆ¶
            echo "ğŸ“¤ Pushing changes to remote..."
            for i in {1..3}; do
              if git push origin data-persistence; then
                echo "âœ… Successfully pushed changes (attempt $i)"
                break
              else
                echo "âŒ Push attempt $i failed, retrying in 5 seconds..."
                sleep 5
                if [[ $i -eq 3 ]]; then
                  echo "âš ï¸ All push attempts failed"
                fi
              fi
            done
          fi

      # ç¼“å­˜é•œåƒä»¥ä¾›ä¸‹æ¬¡ä½¿ç”¨
      - name: Cache Docker image
        if: always()
        run: |
          # ä¿å­˜é•œåƒç¼“å­˜
          if [[ -f /tmp/epic-gamer-image.tar ]]; then
            echo "Image cache already exists"
          else
            echo "Creating image cache for next run..."
            docker save ghcr.io/qin2dim/epic-awesome-gamer:latest -o /tmp/epic-gamer-image.tar
          fi

      # ä¸Šä¼ æ—¥å¿—ä½œä¸º Artifactsï¼ˆå¤‡ä»½ç”¨é€”ï¼‰
      - name: Upload logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: epic-gamer-logs-${{ github.run_id }}
          path: volumes/logs/
          retention-days: 7
          if-no-files-found: ignore

      # ä¸Šä¼ è¿è¡Œæ—¶æ•°æ®ä½œä¸º Artifactsï¼ˆå¤‡ä»½ç”¨é€”ï¼‰
      - name: Upload runtime data
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: epic-gamer-runtime-${{ github.run_id }}
          path: volumes/runtime/
          retention-days: 7
          if-no-files-found: ignore

      # ä¸Šä¼ ç”¨æˆ·æ•°æ®ä½œä¸º Artifactsï¼ˆå¤‡ä»½ç”¨é€”ï¼‰
      - name: Upload user data
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: epic-gamer-userdata-${{ github.run_id }}
          path: volumes/user_data/
          retention-days: 7
          if-no-files-found: ignore
