services:
  # 1. 任务调度器 (Ofelia)
  # 这个服务是唯一会随 `docker compose up -d` 启动的常驻服务。
  # 它的职责是根据 epic-awesome-gamer 服务上定义的标签来定时运行它。
  scheduler:
    image: mcuadros/ofelia:latest
    container_name: ofelia-scheduler
    restart: always
    command: daemon --docker
    volumes:
      # 挂载 Docker socket，让 Ofelia 能够控制宿主机上的其他容器
      - /var/run/docker.sock:/var/run/docker.sock:ro
    depends_on:
      - epic-awesome-gamer

  # 2. 任务执行器 (Worker)
  # 这个服务本身不会自动启动，它仅仅是作为一个“任务模板”被 scheduler 调用。
  epic-awesome-gamer:
    image: ghcr.io/qin2dim/epic-awesome-gamer:latest
    # 【关键】设置为 "no"，这样 `docker compose up -d` 不会启动它。
    # 它只会在被 scheduler 调用时才会创建和运行。
    restart: "no"
    container_name: epic-awesome-gamer # Ofelia 运行时会创建带随机后缀的容器，如 epic-awesome-gamer_run_...
    env_file:
      - .env
    volumes:
      - "./volumes/user_data/:/app/app/user_data"
      - "./volumes/logs/:/app/app/logs"
      - "./volumes/runtime/:/app/app/runtime"
    entrypoint: [ "/usr/bin/tini", "--" ]
    command: xvfb-run --auto-servernum --server-num=1 --server-args='-screen 0, 1920x1080x24' uv run app/deploy.py

    # 【关键】资源优化配置，给予容器更多资源
    mem_limit: 4g     # 限制最大内存为 4GB，防止 C++ 内存泄漏
    # 根据你的宿主机配置，可以取消注释并调整这些值
    shm_size: '2gb'   # 【重要】为 Playwright/Chrome 分配足够的共享内存，防止崩溃或变慢

    # 【关键】Ofelia 的调度配置，通过 labels 定义
    labels:
      ofelia.enabled: "true"

      # 定义一个名为 'run-epic-gamer' 的定时任务
      # 使用 `run` 命令，这意味着 Ofelia 会执行 `docker run` 来创建一个新容器来运行此任务
      ofelia.job-run.epic-gamer.schedule: "${CRON_SCHEDULE:-1 */5 * * *}"
      ofelia.job-run.epic-gamer.image: "ghcr.io/qin2dim/epic-awesome-gamer:latest"
      ofelia.job-run.epic-gamer.command: "xvfb-run --auto-servernum --server-num=1 --server-args='-screen 0, 1920x1080x24' uv run app/deploy.py"

      ofelia.job-run.epic-gamer.pull: "true"                          # 每次运行前强制拉取最新镜像
      ofelia.job-run.epic-gamer.timeout: "10m"                        # 设置 10 分钟超时，超时后 Ofelia 会强力杀死容器
      ofelia.job-run.epic-gamer.no-overlap: "true"                    # 如果上一个任务还没跑完，不启动新的任务
      ofelia.job-run.epic-gamer.save-logs: "true"                     # 保存任务容器的日志，路径在Ofelia容器内
      ofelia.job-run.epic-gamer.rm: "true"                            # 任务结束后自动删除容器
      ofelia.job-run.epic-gamer.env.from: "epic-awesome-gamer"        # 从 epic-awesome-gamer 服务继承环境变量
      ofelia.job-run.epic-gamer.volume.from: "epic-awesome-gamer"     # 从 epic-awesome-gamer 服务继承数据卷挂载